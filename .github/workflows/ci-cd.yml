name: Bend-PVM Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  CARGO_TERM_COLOR: always
  CICD_CACHE_KEY: "2026-v1"

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: QUALITY ASSURANCE (Fast Feedback)
  # ------------------------------------------------------------------
  qa:
    name: üõ°Ô∏è Quality Assurance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: ${{ env.CICD_CACHE_KEY }}

      - name: Install Tools (Nextest & Deny)
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest, cargo-deny

      - name: Check Formatting
        run: cargo fmt --all -- --check

      - name: Security Audit (Dependencies)
        run: cargo deny check advisories

      - name: Linting (Clippy)
        run: cargo clippy --all-features -- -D warnings

      - name: Fast Unit Tests
        run: cargo nextest run --all-features

  # ------------------------------------------------------------------
  # STAGE 2: BUILD & DEPLOY - STAGING
  # ------------------------------------------------------------------
  deploy-staging:
    name: üöÄ Deploy Staging
    needs: qa
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: ${{ env.CICD_CACHE_KEY }}

      - name: Build Staging Artifact
        # Uses our intelligent script with --env staging (Debug symbols enabled)
        run: ./scripts/build.sh --env staging

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bend-pvm-staging
          path: target/release/bend-pvm
          retention-days: 5

      # Placeholder for actual deployment step (e.g., SCP, Docker Push, AWS S3)
      - name: Simulate Deployment
        run: echo "Deploying bend-pvm-staging to Staging Server..."

  # ------------------------------------------------------------------
  # STAGE 3: BUILD & DEPLOY - PRODUCTION
  # ------------------------------------------------------------------
  deploy-production:
    name: üíé Deploy Production
    needs: qa
    # Trigger on main branch or tags starting with 'v'
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: ${{ env.CICD_CACHE_KEY }}

      - name: Build Production Artifact
        # Uses our intelligent script with --env production (LTO, Strip, optimized)
        run: ./scripts/build.sh --env production

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bend-pvm-production
          path: target/release/bend-pvm
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: target/release/bend-pvm
          generate_release_notes: true